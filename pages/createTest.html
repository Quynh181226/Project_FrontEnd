<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <link rel="stylesheet" href="../css/createTest.css"> -->
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/createTest.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/createTest.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <title>Add/edit question</title>
    <style>
        * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
}

body {
    background-color: #f5f5f5;
}

.navbar {
    background-color: #333;
    padding: 15px;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.navbar .logo {
    font-size: 24px;
    font-weight: bold;
}

.navbar a {
    color: white;
    text-decoration: none;
    padding: 10px 20px;
}

.navbar a:hover {
    background-color: #555;
}

#mainContent {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

#mainContent h2 {
    font-size: 24px;
    margin-bottom: 20px;
}

.form-label {
    font-weight: bold;
    margin-bottom: 5px;
}

.form-control,
.form-select {
    margin-bottom: 15px;
}

/* .row {
    display: flex;
    gap: 20px;
    justify-content: start;
} */
/* .row{
    display: flex;
    /* gap: 20px;
    margin-bottom: 20px; */
/* }  */
/* .row div {
    flex: 1;
} */
.row div {
    flex: 1;
    display: flex;
    flex-direction: column;
    /* flex: 1;
    width: 50%; */
}
/* #testName{
    flex: 3;
} */
.btn-primary {
    background-color: #007bff;
    border: none;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.btn-secondary {
    background-color: #6c757d;
    border: none;
}

.btn-secondary:hover {
    background-color: #5a6268;
}

.table {
    margin-top: 20px;
}

.table th,
.table td {
    vertical-align: middle;
    text-align: center;
}

.table th {
    background-color: #333;
    color: white;
}

.table .btn {
    margin: 0 5px;
}

.modal-content {
    padding: 20px;
    border-radius: 5px;
}

.modal-header {
    border-bottom: none;
    padding-bottom: 0;
}

.modal-title {
    font-size: 18px;
    font-weight: bold;
}

.modal-body {
    padding: 10px 0;
}

.answerItem {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.answerItem .form-check-input {
    margin-top: 0;
}

.btnDelete {
    color: red;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 16px;
}

.btn-dark {
    background-color: #333;
    border: none;
}

.btn-dark:hover {
    background-color: #444;
}

.modal-footer {
    border-top: none;
    padding-top: 0;
}

.footer {
    background-color: #333;
    color: white;
    text-align: center;
    padding: 10px;
    position: fixed;
    bottom: 0;
    width: 100%;
}

.input-group {
    display: flex;
    align-items: center;
    position: relative;
}

.btnDelete {
    position: absolute;
    right: 10px;
    top: 6px;
}

.form-control {
    margin: 0;
}

.input-group-text {
    padding: 10px;
}
/* .CateSelect{
    display: flex;
    flex-direction: column;
}
#category{
    padding: 8px;
    border: 1px solid #DEE2E6;
    border-radius: 4px;
} */
 .btnAddSave{
    display: flex;
    justify-content: space-between;
    /* cursor: pointer; */
 }

 .error-message{
    color: red;
    display: none;
 }

 .modal {
     position: fixed;
     left: 0;
     top: 0;
     width: 100%;
     height: 100%;
     background-color: rgba(0, 0, 0, 0.4);
     display: none;
 }

 .modal-content {
     background-color: white;
     margin: 10% auto;
     padding: 20px;
     width: 80%;
     max-width: 600px;
     border-radius: 5px;
 }

 .close {
     color: #aaa;
     float: right;
     font-size: 28px;
     cursor: pointer;
 }

 .close:hover {
     color: #000;
 }
 /* #input-group-answer{
    display: flex;
    gap: 5px;
 } */
  .input-group{
    display: flex;
    margin-bottom: 5px;
  }
    </style>
</head>

<body>
    <!-- Navbar -->
    <header>
        <div class="navbar">
            <div class="logo">QuizzForge</div>
            <nav>
                <a href="#" id="category1">Category</a>
                <a href="#" id="the-test1" class="active">The test</a>
                <a href="#" id="log-out1">Log out</a>
            </nav>
        </div>
    </header>

    <!-- Main -->
    <main>
        <div id="mainContent">
            <h2>Create the test</h2>
            <div id="testNameContainer" class="mb-3">
                <label for="testName" class="form-label">Test name</label>
                <input type="text" id="testName" class="form-control" placeholder="Input test">
                <small class="error-message" id="name-error-empty">Test name is empty</small>
                <small class="error-message" id="name-error-length">Test name must be between(1-50)characters</small>
                <small class="error-message" id="name-error-dupli">Test name exists</small>
            </div>
            <div class="row">
                <div class="CateSelect">
                    <label class="form-label">Category</label>
                    <select id="category-test" class="form-select"></select>
                    <small class="error-message" id="cate-error">Category is empty</small>
                </div>
                <div>
                    <label for="time" class="form-label">Time(minutes)</label>
                    <input type="number" id="time" class="form-control" min="1">
                    <small class="error-message" id="time-error">Time must be greater than 0</small>
                </div>
            </div>
            <h3>Question Management</h3>
            <div class="btnAddSave">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#questionModal">Add
                    question</button>
                <button class="btn btn-primary" id="btn-save-test">Save</button>
            </div>
            <table class="table table-bordered" id="table">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Question</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="test-list-question">

                </tbody>
            </table>
        </div>
    </main>

    <!-- Modal -->
    <section>
        <div class="modal fade" id="questionModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalLabel">Add/edit question</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <label class="form-label">Question</label>
                        <!-- quesssssstion -->
                        <input type="text" id="content-question" class="form-control" placeholder="Input question">
                        <small class="error-message" id="question-error-emp">Question is empty</small>
                        <small class="error-message" id="question-error-length">Test name must be between(1-50)characters</small>
                        <label class="form-label mt-3">Answer</label>
                        <div id="answerList"></div>
                        <small class="error-message" id="answer-error-min">Question must least 2 answers</small>
                        <small class="error-message" id="answer-error-emp">Answer is empty</small>
                        <small class="error-message" id="answer-error-length">Answer must be between(1-50)characters</small>
                        <small class="error-message" id="answer-error-correct">Question must least 1 correct answer</small>

                        <button class="btn btn-dark mt-2" id="addAnswer">Add answer</button>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="save-question">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2025 QuizzForge. All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
    <!-- <script src="../js/createTest.js"></script> -->
    <script>
        const category11 = document.querySelector("#category1")
const theTest = document.querySelector("#the-test1")
const logOut1 = document.querySelector("#log-out1")

category11.addEventListener("click", (e) => {
    window.location = "../pages/categoryManagement.html"
})

theTest.addEventListener("click", (e) => {
    window.location = "../pages/testManagement1.html"
})

logOut1.addEventListener("click", (e) => {
    localStorage.removeItem("isLoggedIn")
    window.location = "../pages/login.html"
})
//function category 
function renderCategory() {
    //lay gtri tren local
    const categories = JSON.parse(localStorage.getItem("arrCategories")||"[]");

    let stringHTML = '<option value="" disabled selected>Select category</option>'

    for (let i = 0; i < categories.length; i++) {
        stringHTML +=
            `
                <option value=${categories[i].id}>
                    ${categories[i].emoji} ${categories[i].name}
                </option>
            `
    }
    document.getElementById('category-test').innerHTML = stringHTML
}
renderCategory();
//Ktra is editTest hay CreateTest
const testEdit=JSON.parse(localStorage.getItem('testEdit')||'null')
const test = testEdit || {
    id: -1,
    testName: "",
    categoryId: -1,
    playTime: 0,
    playAmount: 0,
    questions:[]
}
//If co the test need edit => update interface
if (testEdit) {
    //Change title to Create => Edit
    document.querySelector('h2').textContent = 'Edit the test';
    //Fill in test data in the form
    document.getElementById('testName').value = test.testName
    document.getElementById('category-test').value = test.categoryId
    document.getElementById('time').value = test.playTime
    //Update list test
    questionList = test.questions || [];
    renderTestListQuestion()
}
const inputTestName =document.getElementById('testName');
inputTestName.addEventListener('input', function (e) {
    test.testName = e.target.value;
});

const categoryTest=document.getElementById('category-test');
categoryTest.addEventListener('change', function (e) {
    test.categoryId = +e.target.value;
});

const timeInput=document.getElementById('time');
timeInput.addEventListener('change', function (e) {
    test.playTime = +e.target.value;
});

let questionList = []
let question = {
    content: '',
    answers: [],
}

function renderAnswers() {  
    document.getElementById('answerList').innerHTML = ''
    let answerHtml = ''
    for (let i = 0; i < question.answers.length; i++) {
        answerHtml +=
            `
            <div id="input-group-answer" style="position: relative;">
                <div class="input-group">
                    <div class="input-group-text">
                        <input class="form-check-input mt-0 checkbox-answer" type="checkbox" ${question.answers[i].isCorrected ? 'checked' : ''}
                            aria-label="Checkbox for following text input" id="answer-${i}">
                    </div>

                    <input type="text" class="form-control input-answer" placeholder="Input answer" value='${question.answers[i].answer}'>
                </div>
                <button class="btnDelete btn-del-answer"><img src="../assets/garbage.png"></button>
            </div>
            `
    }
    document.getElementById('answerList').innerHTML = answerHtml

    const inputAnsers = document.querySelectorAll('.input-answer')
    inputAnsers.forEach((el, i) => {
        el.addEventListener('input', (e) => {
            question.answers[i].answer = e.target.value
        })
    })
    
    const checkboxAnswer = document.querySelectorAll('.checkbox-answer')
    checkboxAnswer.forEach((el, i) => {
        el.addEventListener('change', (e) => {
            question.answers[i].isCorrected = e.target.checked
        })
    })
    
    const btnDelAnswer = document.querySelectorAll('.btn-del-answer')
    btnDelAnswer.forEach((el, i) => {
        el.addEventListener('click', (e) => {
            question.answers.splice(i, 1)
            renderAnswers()
        })
    })
}
// renderAnswers()

document.getElementById("addAnswer").addEventListener("click", function () { 
  question.answers.push({
    answer: '',
    isCorrected: false
  })
    renderAnswers()
})

const inputQuestionContent = document.getElementById('content-question')
inputQuestionContent.addEventListener('input',(e) => {
    question.content = e.target.value
})

let editIndex = -1;
function renderTestListQuestion() {
    let testListQuestionHtml = '';
    for (let i = 0; i < questionList.length; i++){
        testListQuestionHtml += 
            `
                <tr>
                    <td>${i+1}</td>
                    <td>${questionList[i].content}</td>
                    <td>
                        <button class="btn-edit-question">Edit</button>
                        <button class="btn-del-question">Xoa</button>
                    </td>
                </tr>
            `
    }
    document.getElementById('test-list-question').innerHTML = testListQuestionHtml
    
    const btnDelQuestion = document.querySelectorAll('.btn-del-question')
    btnDelQuestion.forEach((btnDel, i) => {
        btnDel.addEventListener('click', (e) => {
            questionList.splice(i, 1)
            renderTestListQuestion()
        })
    })
//function editQues
const btnEditQuestion = document.querySelectorAll('.btn-edit-question');
    btnEditQuestion.forEach((btnEdit, i) => {
        btnEdit.addEventListener("click", (e) => {
            // Copy ques and ans
            //1. 
            question = {
                content: questionList[i].content,
                answers: []
            };
            for (let j = 0; j < questionList[i].answers.length; j++) {
                question.answers.push({
                    answer: questionList[i].answers[j].answer,
                    isCorrected: questionList[i].answers[j].isCorrected
                });
            }
            editIndex = i;
            document.getElementById('content-question').value = question.content;
            renderAnswers(); 
            const modalElement = document.getElementById('questionModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        });
    });
}
/////////////////////////////////////
document.getElementById('save-question').addEventListener('click', () => {
    const questionErrorEmp = document.getElementById("question-error-emp")
    const questionErrorLength = document.getElementById("question-error-length")
    const answerErrorMin = document.getElementById("answer-error-min")
    const answerErrorEmp = document.getElementById("answer-error-emp")
    const answerErrorLength = document.getElementById("answer-error-length")
    const answerErrorCorrect = document.getElementById("answer-error-correct")
    let check = true

    // 1. Question not empty
    if (!question.content.trim()) {
        questionErrorEmp.style.display = "block"
        check = false
    } else {
        questionErrorEmp.style.display = "none"
    }

    // 2. Question length between 1 and 50 characters
    if (question.content.length < 1 || question.content.length > 50) {
        questionErrorLength.style.display = "block"
        check = false
    } else {
        questionErrorLength.style.display = "none"
    }

    // 3. At least 2 answers
    if (question.answers.length < 2) {
        answerErrorMin.style.display = "block"
        check = false
    } else {
        answerErrorMin.style.display = "none"
    }

    // 4. Answers not empty
    let hasEmptyAnswer = false
    for (let i = 0; i < question.answers.length; i++) {
        if (!question.answers[i].answer.trim()) {
            hasEmptyAnswer = true
            break
        }
    }
    if (hasEmptyAnswer) {
        answerErrorEmp.style.display = "block"
        check = false
    } else {
        answerErrorEmp.style.display = "none"
    }

    // 5. Answer length between 1 and 50 characters
    let hasInvalidLengthAnswer = false
    for (let i = 0; i < question.answers.length; i++) {
        if (question.answers[i].answer.length < 1 || question.answers[i].answer.length > 50) {
            hasInvalidLengthAnswer = true
            break
        }
    }
    if (hasInvalidLengthAnswer) {
        answerErrorLength.style.display = "block"
        check = false
    } else {
        answerErrorLength.style.display = "none"
    }

    // 6. At least one correct answer
    let hasCorrectAnswer = false
    for (let i = 0; i < question.answers.length; i++) {
        if (question.answers[i].isCorrected) {
            hasCorrectAnswer = true
            break
        }
    }
    if (!hasCorrectAnswer) {
        answerErrorCorrect.style.display = "block"
        check = false
    } else {
        answerErrorCorrect.style.display = "none"
    }

    if (!check) return

    if (editIndex === -1) {
        questionList.push(question);
    } else {
        questionList[editIndex] = {
            content: question.content,
            answers: []
        };
        for (let j = 0; j < question.answers.length; j++) {
            questionList[editIndex].answers.push({
                answer: question.answers[j].answer,
                isCorrected: question.answers[j].isCorrected
            });
        }
        editIndex = -1; 
    }

    document.getElementById('content-question').value = '';
    question = {
        content: '',
        answers: [],
    };
    renderAnswers();
    renderTestListQuestion();
    const modalElement = document.getElementById('questionModal');
    const modal = bootstrap.Modal.getInstance(modalElement);
    modal.hide();
});
///////////////////////////////////
document.getElementById('btn-save-test').addEventListener('click', () => {
    // //Validate data before save
    // //1. testName not empty
    // if (!test.testName.trim()) return 
    // //2. cate not empty
    // if (test.categoryId === -1) return
    // //3. time not <0
    // if (test.playTime <= 0) return
    // //4. quesList <=1(least 1 ques)

    //Tên bài test không được trùng nhau và có độ dài xác định
    // <small class="error-message" id="name-error-emp">Test name cannot be empty</small>
    // <small class="error-message" id="name-error-length">Test name must be between(1-50)characters</small>
    // <small class="error-message" id="name-error-dupli">Test name exists</small>
    // <small class="error-message" id="cate-error">Category is empty</small>
    // <small class="error-message" id="time-error">Time must be greater than 0</small>
    const nameErrorEmpty = document.getElementById("name-error-empty")
    const nameErrorLength = document.getElementById("name-error-length")
    const nameErrorDupli = document.getElementById("name-error-dupli")
    const cateError = document.getElementById("cate-error")
    const timeError = document.getElementById("time-error")
    let check = true

    // 1. Test name not empty
    if (!test.testName.trim()) {
        nameErrorEmpty.style.display = "block"
        check = false
    } else {
        nameErrorEmpty.style.display = "none"
    }

    // 2. Test name length between 1 and 50 characters
    if (test.testName.length < 1 || test.testName.length > 50) {
        nameErrorLength.style.display = "block"
        check = false
    } else {
        nameErrorLength.style.display = "none"
    }

    // 3. Test name not duplicate (skip if editing the same test)
    let listTestLocal = JSON.parse(localStorage.getItem("list-test") || "[]")
    let isDuplicate = false
    if (!testEdit) { // Only check for duplicates when creating a new test
        for (let i = 0; i < listTestLocal.length; i++) {
            if (listTestLocal[i].testName.toLowerCase() === test.testName.toLowerCase()) {
                isDuplicate = true
                break
            }
        }
    }
    if (isDuplicate) {
        nameErrorDupli.style.display = "block"
        check = false
    } else {
        nameErrorDupli.style.display = "none"
    }

    // 4. Category not empty
    if (test.categoryId === -1) {
        cateError.style.display = "block"
        check = false
    } else {
        cateError.style.display = "none"
    }

    // 5. Time greater than 0
    if (test.playTime <= 0) {
        timeError.style.display = "block"
        check = false
    } else {
        timeError.style.display = "none"
    }

    // 6. At least one question
    if (questionList.length === 0) {
        check = false
    }

    if (!check) return

    // Save the test
    if (testEdit) {
        let index = -1;
        for (let i = 0; i < listTestLocal.length; i++) {
            if (listTestLocal[i].id === test.id) {
                index = i
                break;
            }
        }
        if (index !== -1) {
            test.questions = questionList
            listTestLocal[index] = test
        }
    } else {
        if (listTestLocal.length === 0) {
            test.id = 1
        } else {
            test.id = listTestLocal[listTestLocal.length - 1].id + 1
        }
        test.questions = questionList
        listTestLocal.push(test) 
    }

    //??????????? 
    localStorage.setItem('list-test', JSON.stringify(listTestLocal))
    //Reset data and del 'key' after save
    localStorage.removeItem('testEdit');
    test = {
        id: -1,
        testName: "",
        categoryId: -1,
        playTime: 0,
        playAmount: 5,
        questions: []
    };
    questionList = [];
    document.getElementById('testName').value = '';
    document.getElementById('category-test').value = '';
    document.getElementById('time').value = '';
    document.querySelector('h2').textContent = "Create the test"
    renderTestListQuestion()
}) 
    </script>
</body>

</html>